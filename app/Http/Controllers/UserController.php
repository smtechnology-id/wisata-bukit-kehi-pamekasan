<?php

namespace App\Http\Controllers;

use App\Models\Cart;
use App\Models\Checkout;
use App\Models\Product;
use App\Models\Ticket;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Str;

class UserController extends Controller
{
    //
    public function cartAdd($id)
    {
        $ticket = Ticket::find($id);
        if (!$ticket) {
            return redirect()->back()->with('error', 'Ticket not found');
        }
        $user = Auth::user();
        //    cek apakah sudah ada di cart
        $cart = Cart::where('user_id', $user->id)->where('ticket_id', $ticket->id)->first();
        if ($cart) {
            $cart->quantity += 1;
            $cart->save();
        } else {
            $cart = new Cart();
            $cart->quantity = 1;
            $cart->user_id = $user->id;
            $cart->ticket_id = $ticket->id;
            $cart->save();
        }
        return redirect()->back()->with('success', 'Ticket added to cart successfully!');
    }

    public function cartCount()
    {
        return count((array) session('cart'));
    }

    public function cart()
    {
        $cartCount = $this->cartCount();
        $carts = Cart::where('user_id', Auth::user()->id)->get();
        $total = 0;
        foreach ($carts as $cart) {
            $total += $cart->ticket->price * $cart->quantity;
        }
        return view('cart', compact('cartCount', 'carts', 'total'));
    }

    public function cartDestroy($id)
    {
        $cart = Cart::find($id);
        $cart->delete();
        return redirect()->back()->with('success', 'Ticket removed from cart successfully!');
    }

    // Checkout
    public function checkout($id)
    {
        $ticket = Ticket::find($id);
        return view('checkout', compact('ticket'));
    }

    public function checkoutProcess(Request $request)
    {
        $request->validate([
            'ticket_date' => 'required',
            'quantity' => 'required',
            'payment_proof' => 'required|image|mimes:jpeg,png,jpg,gif,svg|max:10048',
        ]);
        $ticket = Ticket::find($request->ticket_id);
        if (!$ticket) {
            return redirect()->back()->with('error', 'Ticket not found');
        }
        if($request->payment_proof){
            $payment_proof = $request->file('payment_proof');
            $payment_proof_name = time().'.'.$payment_proof->getClientOriginalExtension();
            // Use storage instead of public path
            $payment_proof->storeAs('payment_proof', $payment_proof_name, 'public');
        }
        $total_price = $ticket->price * $request->quantity;
        $randomString = Str::random(10);
        $code = 'CHK-' . time() . '-' . $randomString;
        $user = Auth::user();
        $order = new Checkout();
        $order->code = $code;
        $order->user_id = $user->id;
        $order->ticket_id = $request->ticket_id;
        $order->quantity = $request->quantity;
        $order->status = 'pending';
        $order->ticket_date = $request->ticket_date;
        $order->total_price = $total_price;
        $order->payment_proof = $payment_proof_name;
        $order->save();
        return redirect()->route('user.order')->with('success', 'Checkout successfully!');
    }

    // Order
    public function order()
    {
        $orders = Checkout::where('user_id', Auth::user()->id)->get();
        return view('order', compact('orders'));
    }
}
